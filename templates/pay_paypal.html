{% extends "base.html" %}
{% block content %}
<div class="container my-5" style="max-width:560px">
  <div class="card bg-dark border-0 shadow-lg" style="background:rgba(24,26,30,.55);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(14px);border-radius:14px">
    <div class="card-body p-4 text-center">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0"></h5>
        <a class="btn btn-sm btn-outline-light mb-2" href="{{ url_for('dashboard') }}">‚Üê Back to dashboard</a>
      </div>
      <h3 class="mb-2">Pay with PayPal</h3>
      <div class="text-muted mb-3">{{ '%.2f'|format(amount) }} {{ currency }}</div>

      {% if not paypal_client_id %}
        <div class="alert alert-danger">Missing PAYPAL_CLIENT_ID.</div>
      {% else %}
        <div id="paypal-btn" class="d-grid gap-2"></div>
        <div id="pp-err" class="alert alert-danger d-none mt-3">PayPal SDK load error.</div>
      {% endif %}
    </div>
  </div>
</div>

{% if paypal_client_id %}
  <!-- Static SDK tag (reliable) -->
  <script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency={{ currency }}"></script>
  <script>
    (function(){
      if (!window.paypal) {
        document.getElementById('pp-err')?.classList.remove('d-none');
        return;
      }
      paypal.Buttons({
        style: { layout:'vertical', color:'gold', shape:'rect', label:'paypal', height:45 },
        // createOrder: () => fetch('/paypal/create-order', { method: 'post' })
                            // .then(r => r.text()).then(id => id.trim()),
        createOrder: () => fetch('/paypal/create-order', { method: 'POST' })
                    .then(r => {
                        if (!r.ok) throw new Error("Failed to create order"); // handles 400
                        return r.json();
                    })
                    .then(data => {
                        if (!data.id) throw new Error("No order ID returned from server");
                        return data.id;
                    }),  
        onApprove: (data) => {
                  console.log("PayPal onApprove data:", data); // <--- add this
                  return fetch('/paypal/capture-order', {
                      method:'POST',
                      headers:{'Content-Type':'application/json'},
                      body: JSON.stringify({ orderID: data.orderID })
                  })
                  .then(r => r.json())
                  .then(res => {
                    console.log(res);
                      if (res.status === 'COMPLETED') { window.location = '/dashboard'; }
                      else { alert('Payment was not completed.'); }
                  })
              },
        onError: (err) => { console.error(err); alert('PayPal error.'); }
      }).render('#paypal-btn');
    })();
  </script>
{% endif %}
{% endblock %}
